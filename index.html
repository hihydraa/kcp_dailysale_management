<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Sales Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --warn:#f59e0b; --danger:#ef4444;
      --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,#0b1224, #0f172a);
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:32px auto; padding:0 16px}
    header{display:flex; flex-wrap:wrap; align-items:center; gap:16px; margin-bottom:20px}
    h1{font-size:22px; margin:0; font-weight:700; letter-spacing:.2px}
    .filters{
      display:grid; grid-template-columns:repeat(5, minmax(120px,1fr));
      gap:10px; width:100%; margin-top:8px
    }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:16px; padding:18px
    }
    .cards{display:grid; grid-template-columns:repeat(4, 1fr); gap:12px}
    .kpi .value{font-size:28px; font-weight:700}
    .kpi .label{color:var(--muted); font-size:12px}
    .row{display:grid; grid-template-columns:1.2fr .8fr; gap:12px; margin-top:12px}
    .row-2{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    select, input{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:#0b1020; color:var(--text)
    }
    button{
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#1f2937; color:var(--text); cursor:pointer; font-weight:600
    }
    button:hover{filter:brightness(1.1)}
    .progress{
      height:12px; background:#0b1020; border-radius:999px; overflow:hidden; border:1px solid var(--border)
    }
    .progress > span{display:block; height:100%}
    .legend{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}
    .legend .dot{width:10px; height:10px; border-radius:999px; display:inline-block}
    table{width:100%; border-collapse:collapse}
    th, td{padding:10px 8px; border-bottom:1px solid var(--border); text-align:left; white-space:nowrap}
    th{color:#cbd5e1; font-weight:600; font-size:13px}
    .footer{color:var(--muted); font-size:12px; margin-top:14px}
    @media (max-width:960px){
      .cards{grid-template-columns:1fr 1fr}
      .row, .row-2{grid-template-columns:1fr}
      .filters{grid-template-columns:repeat(2, 1fr)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily Sales Dashboard</h1>
      <div class="legend" title="Target vs Actual (Goal)">
        <span class="dot" style="background:var(--accent)"></span>Achieved
        <span class="dot" style="background:var(--warn)"></span>80–99%
        <span class="dot" style="background:var(--danger)"></span>&lt; 80%
      </div>
      <div style="flex:1 1 100%"></div>
      <div class="filters card">
        <div>
          <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:6px">Date From</label>
          <input type="date" id="dateFrom">
        </div>
        <div>
          <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:6px">Date To</label>
          <input type="date" id="dateTo">
        </div>
        <div>
          <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:6px">Branch</label>
          <select id="branchFilter"><option value="">All</option></select>
        </div>
        <div>
          <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:6px">Channel Type</label>
          <select id="typeFilter"><option value="">All</option></select>
        </div>
        <div style="display:flex; gap:8px; align-items:flex-end">
          <button id="applyBtn">Apply</button>
          <button id="resetBtn" title="Clear filters">Reset</button>
        </div>
      </div>
    </header>

    <!-- Overall KPI -->
    <section class="cards">
      <div class="card kpi"><div class="label">Total Target</div><div id="kpiTarget" class="value">-</div></div>
      <div class="card kpi"><div class="label">Total Actual (Goal)</div><div id="kpiActual" class="value">-</div></div>
      <div class="card kpi"><div class="label">Achievement</div><div id="kpiAchv" class="value">-</div></div>
      <div class="card kpi"><div class="label">Records</div><div id="kpiRows" class="value">-</div></div>
    </section>

    <!-- Visual Summary by Branch -->
    <section class="card" style="margin-top:12px">
      <h3 style="margin:0 0 10px 0">การบรรลุเป้าหมายรายสาขา (Visual Summary)</h3>
      <div id="branchSummary"></div>
    </section>

    <div class="row">
      <!-- Channel Type KPI -->
      <section class="card">
        <h3 style="margin:0 0 10px 0">Achievement ตามประเภทช่องทาง (Channel Type KPI)</h3>
        <canvas id="typeChart" height="220"></canvas>
      </section>

      <!-- Overall chart by day -->
      <section class="card">
        <h3 style="margin:0 0 10px 0">สรุปภาพรวม (Overall KPI by Date)</h3>
        <canvas id="dailyChart" height="220"></canvas>
      </section>
    </div>

    <div class="row-2">
      <!-- Channel Breakdown -->
      <section class="card">
        <h3 style="margin:0 0 10px 0">Achievement แยกตามช่องทาง (Channel Breakdown)</h3>
        <canvas id="channelChart" height="240"></canvas>
      </section>

      <!-- Raw table (filtered) -->
      <section class="card">
        <h3 style="margin:0 0 10px 0">ข้อมูล (หลังกรอง)</h3>
        <div style="overflow:auto; max-height:360px">
          <table id="dataTable">
            <thead>
              <tr>
                <th>วันที่</th><th>branch</th><th>channel</th><th>channel_type</th>
                <th>target</th><th>actual (goal)</th><th>achievement</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="footer" id="lastUpdate"></div>
      </section>
    </div>
  </div>

  <script>
    // ----- CONFIG -----
    const SPREADSHEET_ID = '11wQBNB5fuIE-ySyYtjjrc5-YDpyWq82zCCVRe_2PB_M';
    const SHEET_NAME     = 'dailysale';
    // -------------------

    dayjs.extend(dayjs_plugin_customParseFormat);

    // Google Visualization API endpoint (public-readable / Publish to Web / Anyone with link)
    const gvizUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;

    let RAW = [];      // all rows
    let VIEW = [];     // filtered rows

    let charts = {};   // hold Chart.js instances

    // Utilities
    const parseNum = (v) => {
      if (v===null || v===undefined) return 0;
      if (typeof v === 'number') return v;
      return Number(String(v).replace(/,/g,'').trim()) || 0;
    };
    const fmtNum = (n) => n.toLocaleString(undefined, {maximumFractionDigits: 2});
    const ratio = (a,b) => b===0 ? 0 : (a/b);
    const achvColor = (p) => p>=1   ? 'var(--accent)'
                         : p>=0.8 ? 'var(--warn)'
                                  : 'var(--danger)';

    async function fetchSheet(){
      const res = await fetch(gvizUrl, {cache:'no-cache'});
      const text = await res.text();
      // GViz returns: google.visualization.Query.setResponse({...});
      const json = JSON.parse(text.replace(/^[^\(]+\(/,'').replace(/\);?$/,''));
      const cols = json.table.cols.map(c => c.label || c.id);
      const rows = (json.table.rows || []).map(r => r.c.map(c => c ? c.v : null));

      // Expect columns (Thai/English mix): วันที่, branch, channel, channel_type, daily_target_litre, goal
      RAW = rows.map(r => {
        const obj = {};
        cols.forEach((c, i) => obj[c] = r[i]);
        // normalize
        const dateStr = obj['วันที่'] || obj['date'] || obj['Date'] || '';
        // Try M/D/YYYY first, then YYYY-MM-DD
        let d = null;
        if (typeof dateStr === 'string'){
          if (/\d{4}-\d{2}-\d{2}/.test(dateStr)) d = dayjs(dateStr, 'YYYY-MM-DD');
          else d = dayjs(dateStr, ['M/D/YYYY','DD/MM/YYYY','D/M/YYYY']);
        } else if (typeof dateStr === 'object' && dateStr.f) {
          d = dayjs(dateStr.f, ['M/D/YYYY','DD/MM/YYYY','YYYY-MM-DD']);
        } else if (typeof dateStr === 'number'){ // serial?
          // Google GViz usually sends as Date object; but keep simple here
          d = dayjs(new Date(dateStr));
        }
        const dateISO = d?.isValid() ? d.format('YYYY-MM-DD') : '';

        const target = parseNum(obj['daily_target_litre'] ?? obj['target']);
        const actual = parseNum(obj['actual_litre'] ?? obj['goal'] ?? obj['actual']);
        return {
          dateISO,
          rawDate: dateStr,
          branch: (obj['branch'] ?? '').toString(),
          channel: (obj['channel'] ?? '').toString(),
          type: (obj['channel_type'] ?? '').toString(),
          target,
          actual,
          achv: ratio(actual, target)
        };
      }).filter(r => r.dateISO && r.branch);

      document.getElementById('lastUpdate').textContent = 'Last update: ' + new Date().toLocaleString();
      hydrateFilters();
      applyFilters();
    }

    function hydrateFilters(){
      const branchSel = document.getElementById('branchFilter');
      const typeSel = document.getElementById('typeFilter');
      const branches = Array.from(new Set(RAW.map(r => r.branch))).sort();
      const types    = Array.from(new Set(RAW.map(r => r.type))).sort();

      branchSel.innerHTML = '<option value="">All</option>' + branches.map(b=>`<option value="${b}">${b}</option>`).join('');
      typeSel.innerHTML   = '<option value="">All</option>' + types.map(t=>`<option value="${t}">${t}</option>`).join('');

      // default date range (auto)
      const minD = RAW.reduce((m,r)=>!m||r.dateISO<m? r.dateISO:m, null);
      const maxD = RAW.reduce((m,r)=>!m||r.dateISO>m? r.dateISO:m, null);
      document.getElementById('dateFrom').value = minD || '';
      document.getElementById('dateTo').value   = maxD || '';
    }

    function applyFilters(){
      const f = document.getElementById('dateFrom').value;
      const t = document.getElementById('dateTo').value;
      const b = document.getElementById('branchFilter').value;
      const ty= document.getElementById('typeFilter').value;

      VIEW = RAW.filter(r=>{
        if (f && r.dateISO < f) return false;
        if (t && r.dateISO > t) return false;
        if (b && r.branch !== b) return false;
        if (ty && r.type !== ty) return false;
        return true;
      });

      renderAll();
    }

    function renderAll(){
      renderKPI();
      renderBranchSummary();
      renderTypeChart();
      renderDailyChart();
      renderChannelChart();
      renderTable();
    }

    function sum(arr, key){ return arr.reduce((s,x)=>s+(x[key]||0),0); }

    function renderKPI(){
      const tgt = sum(VIEW,'target');
      const act = sum(VIEW,'actual');
      const ach = ratio(act,tgt);

      document.getElementById('kpiTarget').textContent = fmtNum(tgt);
      document.getElementById('kpiActual').textContent = fmtNum(act);
      document.getElementById('kpiAchv').textContent   = (ach*100).toFixed(1)+'%';
      document.getElementById('kpiRows').textContent   = fmtNum(VIEW.length);
    }

    function renderBranchSummary(){
      const box = document.getElementById('branchSummary');
      box.innerHTML = '';
      const groups = groupBy(VIEW, 'branch');
      const entries = Object.keys(groups).sort();
      entries.forEach(br=>{
        const data = groups[br];
        const tgt = sum(data,'target');
        const act = sum(data,'actual');
        const p = ratio(act,tgt);
        const row = document.createElement('div');
        row.style.margin = '10px 0';
        row.innerHTML = `
          <div style="display:flex; justify-content:space-between; font-weight:600; margin-bottom:6px">
            <span>${br}</span>
            <span>${fmtNum(act)} / ${fmtNum(tgt)} • ${(p*100).toFixed(1)}%</span>
          </div>
          <div class="progress"><span style="width:${Math.min(100,p*100)}%; background:${achvColor(p)}"></span></div>
        `;
        box.appendChild(row);
      });
      if(entries.length===0){
        box.innerHTML = '<div style="color:var(--muted)">No data</div>';
      }
    }

    function renderTypeChart(){
      const ctxId = 'typeChart';
      const g = aggregate(VIEW, 'type');
      const labels = g.map(x=>x.key);
      const targets = g.map(x=>x.target);
      const actuals = g.map(x=>x.actual);
      const achvPct = g.map(x=> x.target? (x.actual/x.target*100):0);

      const ds = [
        {label:'Target', data:targets},
        {label:'Actual', data:actuals},
        {label:'Achievement %', data:achvPct, yAxisID:'y1', type:'line'}
      ];
      drawBarLine(ctxId, labels, ds);
    }

    function renderDailyChart(){
      const g = aggregate(VIEW, 'dateISO').sort((a,b)=>a.key.localeCompare(b.key));
      const labels = g.map(x=>x.key);
      const targets = g.map(x=>x.target);
      const actuals = g.map(x=>x.actual);
      const ds = [
        {label:'Target', data:targets},
        {label:'Actual', data:actuals}
      ];
      drawBar('dailyChart', labels, ds);
    }

    function renderChannelChart(){
      const g = aggregate(VIEW, 'channel');
      const labels = g.map(x=>x.key);
      const achv = g.map(x=> x.target? x.actual/x.target*100 : 0);
      drawBar('channelChart', labels, [{label:'Achievement %', data:achv}]);
    }

    function renderTable(){
      const tb = document.querySelector('#dataTable tbody');
      tb.innerHTML = VIEW.map(r=>`
        <tr>
          <td>${r.dateISO}</td>
          <td>${r.branch}</td>
          <td>${r.channel}</td>
          <td>${r.type}</td>
          <td style="text-align:right">${fmtNum(r.target)}</td>
          <td style="text-align:right">${fmtNum(r.actual)}</td>
          <td style="text-align:right">${(r.achv*100).toFixed(1)}%</td>
        </tr>
      `).join('');
    }

    function groupBy(arr, key){
      return arr.reduce((acc, x)=>{
        const k = x[key] ?? '';
        (acc[k] = acc[k] || []).push(x);
        return acc;
      }, {});
    }
    function aggregate(arr, key){
      const g = groupBy(arr, key);
      return Object.keys(g).map(k=>{
        const rows = g[k];
        return { key:k, target: sum(rows,'target'), actual: sum(rows,'actual') };
      });
    }

    // Chart helpers
    function destroy(id){ if(charts[id]){ charts[id].destroy(); delete charts[id]; } }

    function drawBar(id, labels, datasets){
      destroy(id);
      const ctx = document.getElementById(id);
      charts[id] = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets: datasets.map(ds => ({...ds, borderWidth:1})) },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{labels:{color:'#cbd5e1'} } },
          scales:{
            x:{ ticks:{color:'#9ca3af'}, grid:{color:'rgba(255,255,255,0.05)'} },
            y:{ ticks:{color:'#9ca3af'}, grid:{color:'rgba(255,255,255,0.05)'} }
          }
        }
      });
    }

    function drawBarLine(id, labels, datasets){
      destroy(id);
      const ctx = document.getElementById(id);
      charts[id] = new Chart(ctx, {
        data:{ labels, datasets: datasets.map(ds => ({
          ...ds, borderWidth:2, tension:.25, pointRadius:2
        })) },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{labels:{color:'#cbd5e1'} } },
          scales:{
            x:{ ticks:{color:'#9ca3af'}, grid:{color:'rgba(255,255,255,0.05)'} },
            y:{ position:'left', ticks:{color:'#9ca3af'}, grid:{color:'rgba(255,255,255,0.05)'} },
            y1:{ position:'right', ticks:{color:'#9ca3af', callback:(v)=>v+'%'},
                 grid:{drawOnChartArea:false} }
          }
        }
      });
    }

    // Events
    document.getElementById('applyBtn').addEventListener('click', applyFilters);
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      document.getElementById('branchFilter').value='';
      document.getElementById('typeFilter').value='';
      document.getElementById('dateFrom').value='';
      document.getElementById('dateTo').value='';
      VIEW = RAW.slice(); renderAll();
    });

    // Init
    fetchSheet().catch(err=>{
      console.error(err);
      alert('ไม่สามารถดึงข้อมูลจาก Google Sheet ได้\nตรวจสอบสิทธิ์การเข้าถึงหรือการ Publish to web');
    });
  </script>
</body>
</html>
