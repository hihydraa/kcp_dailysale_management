<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Sales Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--text:#e5e7eb;--accent:#22c55e;--warn:#f59e0b;--danger:#ef4444;--border:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0b1224,#0f172a);color:var(--text)}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    header{display:flex;flex-wrap:wrap;align-items:center;gap:16px;margin-bottom:20px}
    h1{font-size:22px;margin:0;font-weight:700}
    .filters{display:grid;grid-template-columns:repeat(5,minmax(120px,1fr));gap:10px;width:100%}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi .value{font-size:28px;font-weight:700}.kpi .label{color:var(--muted);font-size:12px}
    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:12px}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    select,input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1020;color:var(--text)}
    button{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#1f2937;color:var(--text);cursor:pointer;font-weight:600}
    button:hover{filter:brightness(1.1)}
    .progress{height:12px;background:#0b1020;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
    .progress>span{display:block;height:100%}
    .legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
    .legend .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
    th{color:#cbd5e1;font-weight:600;font-size:13px}
    .footer{color:var(--muted);font-size:12px;margin-top:14px}
    @media (max-width:960px){.cards{grid-template-columns:1fr 1fr}.row,.row-2{grid-template-columns:1fr}.filters{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily Sales Dashboard</h1>
      <div class="legend" title="Target vs Actual">
        <span class="dot" style="background:var(--accent)"></span>≥100%
        <span class="dot" style="background:var(--warn)"></span>80–99%
        <span class="dot" style="background:var(--danger)"></span>&lt;80%
      </div>
      <div class="filters card">
        <div><label style="display:block;color:var(--muted);font-size:12px;margin-bottom:6px">Date From</label><input type="date" id="dateFrom"></div>
        <div><label style="display:block;color:var(--muted);font-size:12px;margin-bottom:6px">Date To</label><input type="date" id="dateTo"></div>
        <div><label style="display:block;color:var(--muted);font-size:12px;margin-bottom:6px">Branch</label><select id="branchFilter"><option value="">All</option></select></div>
        <div><label style="display:block;color:var(--muted);font-size:12px;margin-bottom:6px">Channel Type</label><select id="typeFilter"><option value="">All</option></select></div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button id="applyBtn">Apply</button>
          <button id="resetBtn">Reset</button>
        </div>
      </div>
    </header>

    <section class="cards">
      <div class="card kpi"><div class="label">Total Target</div><div id="kpiTarget" class="value">-</div></div>
      <div class="card kpi"><div class="label">Total Actual</div><div id="kpiActual" class="value">-</div></div>
      <div class="card kpi"><div class="label">Achievement</div><div id="kpiAchv" class="value">-</div></div>
      <div class="card kpi"><div class="label">Records</div><div id="kpiRows" class="value">-</div></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3 style="margin:0 0 10px 0">การบรรลุเป้าหมายรายสาขา (Visual Summary)</h3>
      <div id="branchSummary"></div>
    </section>

    <div class="row">
      <section class="card"><h3 style="margin:0 0 10px 0">Achievement ตามประเภทช่องทาง</h3><canvas id="typeChart" height="220"></canvas></section>
      <section class="card"><h3 style="margin:0 0 10px 0">สรุปภาพรวมรายวัน</h3><canvas id="dailyChart" height="220"></canvas></section>
    </div>

    <div class="row-2">
      <section class="card"><h3 style="margin:0 0 10px 0">Achievement แยกตามช่องทาง</h3><canvas id="channelChart" height="240"></canvas></section>
      <section class="card">
        <h3 style="margin:0 0 10px 0">ข้อมูล (หลังกรอง)</h3>
        <div style="overflow:auto;max-height:360px">
          <table id="dataTable">
            <thead><tr><th>วันที่</th><th>branch</th><th>channel</th><th>channel_type</th><th>target</th><th>actual</th><th>achievement</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="footer" id="lastUpdate"></div>
      </section>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const SPREADSHEET_ID = '11wQBNB5fuIE-ySyYtjjrc5-YDpyWq82zCCVRe_2PB_M';
    const SHEET_NAME     = 'dailysale'; // Share: Anyone with the link (Viewer)

    dayjs.extend(dayjs_plugin_customParseFormat);

    // ---------- UTIL ----------
    const parseNum = v => (v==null) ? 0 : (typeof v==='number'? v : (Number(String(v).replace(/,/g,'').trim()) || 0));
    const fmtNum = n => n.toLocaleString(undefined,{maximumFractionDigits:2});
    const ratio = (a,b) => b===0 ? 0 : a/b;
    const achvColor = p => p>=1 ? 'var(--accent)' : (p>=0.8 ? 'var(--warn)' : 'var(--danger)');

    // ====== Y-axis locking helpers ======
    let YMAX_TYPE = null;    // left y of Channel Type chart
    let YMAX_DAILY = null;   // left y of Daily chart
    const EXCLUDE_TODAY = false; // set true to drop today's moving data

    function niceMax(n){
      if (!isFinite(n) || n <= 0) return 1;
      const p = 10 ** Math.floor(Math.log10(n));
      return Math.ceil((n * 1.1) / p) * p; // +10% and round up to nice step
    }

    // ---------- GViz fetch ----------
    async function fetchGViz(sheetName){
      const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const res = await fetch(url, { cache: 'no-store' });
      const text = await res.text();
      if (!text.includes('google.visualization')) {
        throw new Error('โหลดชีทไม่สำเร็จ (สิทธิ์/ชื่อชีต) : ' + text.slice(0,160));
      }
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const cols = json.table.cols.map(c => c.label || c.id);
      const rows = (json.table.rows||[]).map(r => (r.c||[]).map(c => c ? (c.f ?? c.v ?? '') : ''));
      return rows.map(r => Object.fromEntries(r.map((v,i) => [cols[i] || `col${i+1}`, v])));
    }

    // ---------- normalize ----------
    function normalizeRow(obj){
      const rawDate = obj['วันที่'] || obj['date'] || obj['Date'] || '';
      let dateISO = '';
      if (typeof rawDate === 'string') {
        if (/^\d{4}-\d{2}-\d{2}$/.test(rawDate)) dateISO = rawDate;
        else {
          const d = dayjs(rawDate, ['M/D/YYYY','D/M/YYYY','DD/MM/YYYY','YYYY-MM-DD'], true);
          if (d.isValid()) dateISO = d.format('YYYY-MM-DD');
        }
      }
      const target = parseNum(obj['daily_target_litre'] ?? obj['target']);
      const actual = parseNum(obj['actual_litre'] ?? obj['goal'] ?? obj['actual']);
      return {
        dateISO,
        branch: (obj['branch'] ?? '').toString(),
        channel: (obj['channel'] ?? '').toString(),
        type: (obj['channel_type'] ?? '').toString(),
        target, actual, achv: ratio(actual, target)
      };
    }

    // ---------- State ----------
    let RAW=[], VIEW=[], charts={};

    function hydrateFilters(){
      const branches = [...new Set(RAW.map(r=>r.branch))].sort();
      const types    = [...new Set(RAW.map(r=>r.type))].sort();
      branchFilter.innerHTML = '<option value="">All</option>'+branches.map(b=>`<option value="${b}">${b}</option>`).join('');
      typeFilter.innerHTML   = '<option value="">All</option>'+types.map(t=>`<option value="${t}">${t}</option>`).join('');
      const minD = RAW.reduce((m,r)=>!m||r.dateISO<m? r.dateISO:m, null);
      const maxD = RAW.reduce((m,r)=>!m||r.dateISO>m? r.dateISO:m, null);
      dateFrom.value=minD||''; dateTo.value=maxD||'';
    }

    function applyFilters(){
      const f=dateFrom.value, t=dateTo.value, b=branchFilter.value, ty=typeFilter.value;
      const todayISO = dayjs().format('YYYY-MM-DD');

      VIEW = RAW.filter(r=>{
        if (EXCLUDE_TODAY && r.dateISO === todayISO) return false;
        if (f && r.dateISO<f) return false;
        if (t && r.dateISO>t) return false;
        if (b && r.branch!==b) return false;
        if (ty && r.type!==ty) return false;
        return true;
      });

      renderAll();
    }

    function sum(arr,key){ return arr.reduce((s,x)=>s+(x[key]||0),0); }

    function renderKPI(){
      const tgt=sum(VIEW,'target'), act=sum(VIEW,'actual'), ach=ratio(act,tgt);
      kpiTarget.textContent = fmtNum(tgt);
      kpiActual.textContent = fmtNum(act);
      kpiAchv.textContent   = (ach*100).toFixed(1)+'%';
      kpiRows.textContent   = fmtNum(VIEW.length);
    }

    function renderBranchSummary(){
      const box = document.getElementById('branchSummary'); box.innerHTML='';
      const byB = VIEW.reduce((a,r)=>((a[r.branch]=a[r.branch]||[]).push(r),a),{});
      Object.keys(byB).sort().forEach(br=>{
        const tgt=sum(byB[br],'target'), act=sum(byB[br],'actual'), p=ratio(act,tgt);
        const row=document.createElement('div'); row.style.margin='10px 0';
        row.innerHTML = `
          <div style="display:flex;justify-content:space-between;font-weight:600;margin-bottom:6px">
            <span>${br}</span><span>${fmtNum(act)} / ${fmtNum(tgt)} • ${(p*100).toFixed(1)}%</span>
          </div>
          <div class="progress"><span style="width:${Math.min(100,p*100)}%;background:${achvColor(p)}"></span></div>`;
        box.appendChild(row);
      });
      if (!Object.keys(byB).length) box.innerHTML = '<div style="color:var(--muted)">No data</div>';
    }

    function drawBar(id, labels, datasets, opts={}){
      if(charts[id]){ charts[id].destroy(); delete charts[id]; }
      charts[id] = new Chart(document.getElementById(id),{
        type:'bar',
        data:{ labels, datasets: datasets.map(d=>({...d, borderWidth:1})) },
        options:{
          animation:false,
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{labels:{color:'#cbd5e1'}} },
          scales:{
            x:{ticks:{color:'#9ca3af'},grid:{color:'rgba(255,255,255,.05)'}},
            y:{beginAtZero:true, max: opts.yMaxLeft ?? undefined,
               ticks:{color:'#9ca3af'},grid:{color:'rgba(255,255,255,.05)'}}
          }
        }
      });
    }

    function drawBarLine(id, labels, datasets, opts={}){
      if(charts[id]){ charts[id].destroy(); delete charts[id]; }
      charts[id] = new Chart(document.getElementById(id),{
        data:{ labels, datasets: datasets.map(d=>({...d, borderWidth:2, tension:.25, pointRadius:2})) },
        options:{
          animation:false,
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{labels:{color:'#cbd5e1'}} },
          scales:{
            x:{ticks:{color:'#9ca3af'},grid:{color:'rgba(255,255,255,.05)'}},
            y:{position:'left', beginAtZero:true, max: opts.yMaxLeft ?? undefined,
               ticks:{color:'#9ca3af'},grid:{color:'rgba(255,255,255,.05)'}},
            y1:{position:'right', min:0, max:120,
                ticks:{color:'#9ca3af', callback:v=>v+'%'},
                grid:{drawOnChartArea:false}}
          }
        }
      });
    }

    function renderTypeChart(){
      const g = Object.values(VIEW.reduce((a,r)=>{
        const k=r.type||''; (a[k]=a[k]||{key:k,target:0,actual:0}); a[k].target+=r.target; a[k].actual+=r.actual; return a;
      },{}));
      const labels=g.map(x=>x.key),
            targets=g.map(x=>x.target),
            actuals=g.map(x=>x.actual),
            pct=g.map(x=>x.target? x.actual/x.target*100:0);

      if (YMAX_TYPE === null) {
        const peak = Math.max(1, ...targets, ...actuals);
        YMAX_TYPE = niceMax(peak);
      }

      drawBarLine('typeChart', labels, [
        {label:'Target', data:targets, type:'bar'},
        {label:'Actual', data:actuals, type:'bar'},
        {label:'Achievement %', data:pct, type:'line', yAxisID:'y1'}
      ], { yMaxLeft: YMAX_TYPE });
    }

    function renderDailyChart(){
      const g = Object.values(VIEW.reduce((a,r)=>{
        const k=r.dateISO||''; (a[k]=a[k]||{key:k,target:0,actual:0}); a[k].target+=r.target; a[k].actual+=r.actual; return a;
      },{})).sort((x,y)=>x.key.localeCompare(y.key));

      if (YMAX_DAILY === null) {
        const dailyPeaks = g.map(x=>Math.max(x.target, x.actual));
        YMAX_DAILY = niceMax(Math.max(1, ...dailyPeaks));
      }

      drawBar('dailyChart', g.map(x=>x.key), [
        {label:'Target', data:g.map(x=>x.target)},
        {label:'Actual', data:g.map(x=>x.actual)}
      ], { yMaxLeft: YMAX_DAILY });
    }

    function renderChannelChart(){
      const g = Object.values(VIEW.reduce((a,r)=>{
        const k=r.channel||''; (a[k]=a[k]||{key:k,target:0,actual:0}); a[k].target+=r.target; a[k].actual+=r.actual; return a;
      },{}));
      drawBar('channelChart', g.map(x=>x.key), [
        {label:'Achievement %', data:g.map(x=>x.target?x.actual/x.target*100:0)}
      ], { yMaxLeft: 100 }); // ไม่จำเป็นจริง ๆ เพราะเป็น %
    }

    function renderTable(){
      const tb=document.querySelector('#dataTable tbody');
      tb.innerHTML = VIEW.map(r=>`
        <tr>
          <td>${r.dateISO}</td><td>${r.branch}</td><td>${r.channel}</td><td>${r.type}</td>
          <td style="text-align:right">${fmtNum(r.target)}</td>
          <td style="text-align:right">${fmtNum(r.actual)}</td>
          <td style="text-align:right">${(r.achv*100).toFixed(1)}%</td>
        </tr>`).join('');
    }

    function renderAll(){ renderKPI(); renderBranchSummary(); renderTypeChart(); renderDailyChart(); renderChannelChart(); renderTable(); }

    // ---------- INIT ----------
    document.getElementById('applyBtn').addEventListener('click', ()=>{
      // รีล็อก y-axis เมื่อผู้ใช้เปลี่ยนช่วงฟิลเตอร์เท่านั้น
      YMAX_TYPE = null;
      YMAX_DAILY = null;
      applyFilters();
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      branchFilter.value=''; typeFilter.value='';
      dateFrom.value=''; dateTo.value='';
      YMAX_TYPE = null; YMAX_DAILY = null;
      VIEW = RAW.slice(); renderAll();
    });

    (async function init(){
      try{
        const rawRows = await fetchGViz(SHEET_NAME);
        RAW = rawRows.map(normalizeRow).filter(r=>r.dateISO && r.branch);
        document.getElementById('lastUpdate').textContent = 'Last update: ' + new Date().toLocaleString();
        hydrateFilters(); applyFilters();
      }catch(err){
        console.error(err);
        alert('โหลดข้อมูลจาก Google Sheet ไม่สำเร็จ:\n' + (err.message || err));
      }
    })();
  </script>
</body>
</html>
