<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á (Real‚ÄëTime)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <!-- ALERT AREA -->
  <div id="alert" class="hidden mb-4 p-3 rounded border bg-red-50 text-red-700 border-red-200"></div>

  <h1 class="text-2xl font-bold text-center mb-4">üìä Dashboard ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á (Real‚ÄëTime)</h1>
  <p class="text-center text-gray-600 mb-4">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÅ‡∏ö‡∏ö Real‚ÄëTime (Sheet: <code>dailysale</code>)</p>

  <!-- Filters -->
  <div class="flex flex-wrap gap-4 justify-center mb-8">
    <div>
      <label class="block text-sm font-medium">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="startDate" class="border rounded p-2">
    </div>
    <div>
      <label class="block text-sm font-medium">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="endDate" class="border rounded p-2">
    </div>
    <div>
      <label class="block text-sm font-medium">‡∏™‡∏≤‡∏Ç‡∏≤ (Branch)</label>
      <select id="branchSelect" class="border rounded p-2 min-w-[160px]"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
    </div>
    <div>
      <label class="block text-sm font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (Channel Type)</label>
      <select id="typeSelect" class="border rounded p-2 min-w-[160px]"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option>Front</option><option>MT</option><option>TR</option><option>Back</option><option>CH</option></select>
    </div>
    <button id="filterBtn" class="bg-indigo-600 text-white px-4 py-2 rounded">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button id="resetBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
  </div>

  <!-- KPI Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white shadow rounded p-4 text-center">
      <h3 class="text-sm text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Actual)</h3>
      <p id="kpiActual" class="text-2xl font-bold">-</p>
    </div>
    <div class="bg-white shadow rounded p-4 text-center">
      <h3 class="text-sm text-gray-500">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Target)</h3>
      <p id="kpiTarget" class="text-2xl font-bold">-</p>
    </div>
    <div class="bg-white shadow rounded p-4 text-center">
      <h3 class="text-sm text-gray-500">% Achievement</h3>
      <p id="kpiAch" class="text-2xl font-bold">-</p>
      <div class="mt-2">
        <div class="h-2 bg-gray-200 rounded">
          <div id="kpiAchBar" class="h-2 rounded" style="width:0%"></div>
        </div>
      </div>
    </div>
    <div class="bg-white shadow rounded p-4 text-center">
      <h3 class="text-sm text-gray-500">‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 70%</h3>
      <p id="kpiBelow" class="text-2xl font-bold text-red-600">-</p>
      <p id="branchBelow" class="text-xs text-gray-600 mt-2">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</p>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white shadow rounded p-4">
      <h3 class="font-semibold mb-2">‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤ (%Ach)</h3>
      <canvas id="branchChart" height="140"></canvas>
    </div>
    <div class="bg-white shadow rounded p-4">
      <h3 class="font-semibold mb-2">Achievement ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (%Ach)</h3>
      <canvas id="typeChart" height="140"></canvas>
    </div>
  </div>

  <!-- Trend -->
  <div class="bg-white shadow rounded p-4 mt-6">
    <h3 class="font-semibold mb-2">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Actual vs Target)</h3>
    <canvas id="trendChart" height="120"></canvas>
  </div>

  <!-- Table -->
  <div class="bg-white shadow rounded p-4 mt-6 overflow-x-auto">
    <h3 class="font-semibold mb-3 text-center">Channel Breakdown</h3>
    <table class="min-w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-2 py-1">Branch</th>
          <th class="border px-2 py-1">Channel</th>
          <th class="border px-2 py-1">Type</th>
          <th class="border px-2 py-1 text-right">Target (L)</th>
          <th class="border px-2 py-1 text-right">Actual (L)</th>
          <th class="border px-2 py-1 text-right">%</th>
          <th class="border px-2 py-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        </tr>
      </thead>
      <tbody id="tblBody"></tbody>
    </table>
  </div>

<script>
const SHEET_ID = '11wQBNB5fuIE-ySyYtjjrc5-YDpyWq82zCCVRe_2PB_M';
const SHEET_NAME = 'dailysale';

let rawData = [];
let filtered = [];
let charts = {};

const el = {
  startDate: document.getElementById('startDate'),
  endDate: document.getElementById('endDate'),
  branchSelect: document.getElementById('branchSelect'),
  typeSelect: document.getElementById('typeSelect'),
  filterBtn: document.getElementById('filterBtn'),
  resetBtn: document.getElementById('resetBtn'),
  kpiTarget: document.getElementById('kpiTarget'),
  kpiActual: document.getElementById('kpiActual'),
  kpiAch: document.getElementById('kpiAch'),
  kpiAchBar: document.getElementById('kpiAchBar'),
  kpiBelow: document.getElementById('kpiBelow'),
  branchBelow: document.getElementById('branchBelow'),
  tblBody: document.getElementById('tblBody')
};

const toNum = v => isNaN(+v)?0:+v;
const fmt = n => (n||0).toLocaleString();
const pct = (a,t)=>t?(a/t*100):0;
const kpiBarColor = p => p<70?'bg-red-500':(p<90?'bg-yellow-500':'bg-green-500');
const barColor = kpiBarColor;

function progressBar(p){
  const capped=Math.max(0,Math.min(120,p));
  return `
    <div class='relative' style='width:160px'>
      <div class='h-2 bg-gray-200 rounded'>
        <div class='h-2 ${barColor(p)} rounded' style='width:${Math.min(capped,100)}%'></div>
      </div>
      <div class='absolute top-1/2 -translate-y-1/2' style='left:100%'>
        <div class='w-0.5 h-3 bg-gray-700'></div>
      </div>
      <div class='text-xs text-gray-600 mt-1'>${p.toFixed(1)}%</div>
    </div>`;
}

function aggBy(keys){
  const map=new Map();
  for(const r of filtered){
    const k=keys.map(k=>r[k]).join('|');
    if(!map.has(k)) map.set(k,{...keys.reduce((o,k)=>(o[k]=r[k],o),{}),target:0,actual:0});
    const o=map.get(k);
    o.target+=toNum(r.daily_target_litre);
    o.actual+=toNum(r.actual_litre);
  }
  return [...map.values()];
}

function applyFilters(){
  const s=el.startDate.value, e=el.endDate.value, b=el.branchSelect.value, t=el.typeSelect.value;
  filtered=rawData.filter(r=>{
    const okS=s?(new Date(r.date)>=new Date(s)):true;
    const okE=e?(new Date(r.date)<=new Date(e)):true;
    const okB=b?r.branch===b:true;
    const okT=t?r.channel_type===t:true;
    return okS&&okE&&okB&&okT;
  });
  refresh();
}

function resetFilters(){
  el.startDate.value=''; el.endDate.value=''; el.branchSelect.value=''; el.typeSelect.value=''; filtered=[...rawData]; refresh();
}

function populateFilters(){
  const prevBranch = el.branchSelect.value;
  const branches = [...new Set(rawData.map(r=>r.branch))].filter(Boolean).sort();
  el.branchSelect.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' +
    branches.map(b=>`<option ${b===prevBranch?'selected':''}>${b}</option>`).join('');
}

function updateKPIs(){
  const totalTarget=filtered.reduce((a,r)=>a+toNum(r.daily_target_litre),0);
  const totalActual=filtered.reduce((a,r)=>a+toNum(r.actual_litre),0);
  const ach=pct(totalActual,totalTarget);
  el.kpiTarget.textContent=fmt(totalTarget);
  el.kpiActual.textContent=fmt(totalActual);
  el.kpiAch.textContent=`${ach.toFixed(1)}%`;
  el.kpiAchBar.className=`h-2 rounded ${kpiBarColor(ach)}`;
  el.kpiAchBar.style.width=`${Math.min(ach,100)}%`;

  const byChannel=aggBy(['branch','channel','channel_type']);
  const below=byChannel.filter(x=>pct(x.actual,x.target)<70);
  el.kpiBelow.textContent=below.length;
  const branchesBelow=[...new Set(below.map(x=>x.branch))];
  if(branchesBelow.length){
    // ‡πÅ‡∏™‡∏î‡∏á % ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏î‡πâ‡∏ß‡∏¢
    const byBranch = aggBy(['branch']);
    const map = new Map(byBranch.map(x=>[x.branch, (pct(x.actual,x.target)||0)]));
    el.branchBelow.textContent = branchesBelow.map(b=>`${b} (${(map.get(b)||0).toFixed(1)}%)`).join(', ');
  }else{
    el.branchBelow.textContent='(‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 70%)';
  }
}

function renderCharts(){ for(const k in charts){ charts[k].destroy(); } charts={};
  const byBranch=aggBy(['branch']);
  const labelsB=byBranch.map(x=>x.branch);
  const dataB=byBranch.map(x=>+(pct(x.actual,x.target).toFixed(1)));
  charts.branch=new Chart(document.getElementById('branchChart').getContext('2d'),{type:'bar',data:{labels:labelsB,datasets:[{label:'% Achievement',data:dataB}]},options:{responsive:true,scales:{y:{beginAtZero:true,max:130}}}});
  const byType=aggBy(['channel_type']).map(x=>({type:x.channel_type,p:pct(x.actual,x.target)}));
  const labelsT=byType.map(x=>x.type);
  const dataT=byType.map(x=>+(x.p.toFixed(1)));
  charts.type=new Chart(document.getElementById('typeChart').getContext('2d'),{type:'bar',data:{labels:labelsT,datasets:[{label:'% Achievement',data:dataT}]},options:{responsive:true,scales:{y:{beginAtZero:true,max:130}}}});
  const byDate=(()=>{const m=new Map();for(const r of filtered){const k=r.date||'';if(!m.has(k))m.set(k,{date:k,target:0,actual:0});const o=m.get(k);o.target+=toNum(r.daily_target_litre);o.actual+=toNum(r.actual_litre);}return[...m.values()].sort((a,b)=>new Date(a.date)-new Date(b.date));})();
  charts.trend=new Chart(document.getElementById('trendChart').getContext('2d'),{type:'line',data:{labels:byDate.map(x=>x.date),datasets:[{label:'Target',data:byDate.map(x=>x.target)},{label:'Actual',data:byDate.map(x=>x.actual)}]},options:{responsive:true}});
}

function renderTable(){ const tb=el.tblBody; tb.innerHTML=''; const rows=aggBy(['branch','channel','channel_type']).sort((a,b)=>(a.branch+a.channel).localeCompare(b.branch+b.channel)); for(const r of rows){ const p=pct(r.actual,r.target); const tr=document.createElement('tr'); tr.innerHTML=`<td class='border px-2 py-1'>${r.branch}</td><td class='border px-2 py-1'>${r.channel}</td><td class='border px-2 py-1'>${r.channel_type||''}</td><td class='border px-2 py-1 text-right'>${fmt(r.target)}</td><td class='border px-2 py-1 text-right'>${fmt(r.actual)}</td><td class='border px-2 py-1 text-right'>${p.toFixed(1)}%</td><td class='border px-2 py-1'>${progressBar(p)}</td>`; tb.appendChild(tr);} }

function refresh(){ updateKPIs(); renderCharts(); renderTable(); }

// ---- GViz Loader with error handling ----
async function loadFromGViz(){
  try{
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tq=${encodeURIComponent('select *')}&tqx=out:json`;
    const resp = await fetch(url, { cache: 'no-store' });
    if(!resp.ok){ throw new Error(`HTTP ${resp.status} ${resp.statusText}`); }
    const text = await resp.text();
    const start = text.indexOf('{');
    const end = text.lastIndexOf('}');
    if(start<0 || end<0){ throw new Error('GViz returned unexpected format'); }
    const json = JSON.parse(text.substring(start, end + 1));
    const cols = (json.table.cols || []).map(c => (c.label || c.id || '').toString().trim());
    const rows = (json.table.rows || []).map(r => {
      const o = {};
      (r.c || []).forEach((cell, i) => {
        const val = cell ? (cell.f ?? cell.v ?? '') : '';
        o[cols[i] || `col${i}`] = val;
      });
      return o;
    });
    hideAlert();
    normalizeAndSet(rows);
  }catch(err){
    console.error('[GViz] load error:', err);
    showAlert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ: ${err.message} \n‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤: 1) Sheet ID ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á, 2) ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô "${SHEET_NAME}", 3) ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏ô Anyone with the link / Published to web`);
  }
}

function normalizeAndSet(json){
  const mapKey=k=>(k||'').toString().trim().toLowerCase();
  const parseDate = (v)=>{
    if(!v) return '';
    if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(v)) return v;
    const d = new Date(v);
    if(!isNaN(d.getTime())){
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    }
    return v;
  };

  rawData = json.map(r=>({
    date: parseDate(r.date||r.Date||r.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà||r[Object.keys(r).find(k=>mapKey(k)==='date')]||''),
    branch: r.branch||r.Branch||r.‡∏™‡∏≤‡∏Ç‡∏≤||r[Object.keys(r).find(k=>mapKey(k)==='branch')]||'',
    channel: r.channel||r.Channel||r.‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á||r[Object.keys(r).find(k=>mapKey(k)==='channel')]||'',
    channel_type: r.channel_type||r.Channel_type||r.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á||r[Object.keys(r).find(k=>mapKey(k)==='channel_type')]||'',
    daily_target_litre: toNum(r.daily_target_litre??r.target??r.Target??r.‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢??r['daily_target_litre']),
    actual_litre: toNum(r.actual_litre??r.actual??r.Actual??r.‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢??r['actual_litre'])
  }));
  populateFilters();
  applyFilters();
}

// ---- Alert helpers ----
function showAlert(msg){ const a=document.getElementById('alert'); a.textContent=msg; a.classList.remove('hidden'); }
function hideAlert(){ const a=document.getElementById('alert'); a.classList.add('hidden'); a.textContent=''; }

// Events
el.filterBtn.addEventListener('click',applyFilters);
el.resetBtn.addEventListener('click',resetFilters);

// Init
(async function init(){ await loadFromGViz(); setInterval(loadFromGViz,15000); })();
</script>
</body>
</html>
