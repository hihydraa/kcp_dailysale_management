<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Sales Dashboard (Google Sheets)</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{ color-scheme: dark; }
    body { background:#0f172a; color:#E5E7EB; }
    .card { background:#0b1223; border:1px solid rgba(255,255,255,.06); border-radius:16px; }
    .kpi { font-variation-settings:"wght" 700; }
    .progress-outer{ height:14px; background:#1f2937; border-radius:999px; overflow:hidden;}
    .progress-inner{ height:100%; background:#ef4444; }
    .small{ font-size:12px; color:#9CA3AF; }
    .pill{ padding:.25rem .5rem; border-radius:999px; background:#111827; border:1px solid rgba(255,255,255,.08); }
    .ghost-input{ background:#0b1223; border:1px solid rgba(255,255,255,.12); color:#E5E7EB; border-radius:.6rem; padding:.55rem .75rem;}
    .grid-autofill{ display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px;}
    a { color:#60A5FA; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex items-center gap-3 mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold">Daily Sales Dashboard</h1>
      <span class="pill small">Google Sheet → dailysale</span>
    </div>

    <!-- Filters -->
    <div class="card p-4 mb-6">
      <div class="grid md:grid-cols-5 gap-4 items-end">
        <div>
          <label class="block small mb-1">ตั้งแต่วันที่ (mm/dd/yyyy)</label>
          <input id="fromDate" class="ghost-input w-full" type="date" />
        </div>
        <div>
          <label class="block small mb-1">ถึงวันที่ (mm/dd/yyyy)</label>
          <input id="toDate" class="ghost-input w-full" type="date" />
        </div>
        <div class="md:col-span-2">
          <label class="block small mb-1">สาขา (Branch)</label>
          <select id="branchSelect" class="ghost-input w-full">
            <option value="__all__">All</option>
          </select>
        </div>
        <div class="flex gap-3">
          <button id="applyBtn" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500">Apply</button>
          <button id="resetBtn" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">Reset</button>
        </div>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid-autofill mb-6">
      <div class="card p-5">
        <div class="small mb-1">Total Target</div>
        <div id="kpiTarget" class="text-3xl kpi">-</div>
      </div>
      <div class="card p-5">
        <div class="small mb-1">Total Actual</div>
        <div id="kpiActual" class="text-3xl kpi">-</div>
      </div>
      <div class="card p-5">
        <div class="small mb-1">Achievement</div>
        <div id="kpiAch" class="text-3xl kpi">-</div>
      </div>
      <div class="card p-5">
        <div class="small mb-1">Records</div>
        <div id="kpiRecords" class="text-3xl kpi">-</div>
      </div>
    </div>

    <!-- Visual summary per branch -->
    <div class="card p-5 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">การบรรลุเป้าหมายรายสาขา (Visual Summary)</h2>
        <span id="legend" class="small">แถบ = Actual / Target</span>
      </div>
      <div id="branchBars" class="space-y-4"></div>
    </div>

    <!-- Charts row -->
    <div class="grid md:grid-cols-2 gap-6 mb-10">
      <div class="card p-5">
        <h3 class="text-lg font-semibold mb-3">สรุปภาพรวม (Overall KPI)</h3>
        <canvas id="overallChart" height="160"></canvas>
      </div>
      <div class="card p-5">
        <h3 class="text-lg font-semibold mb-3">Achievement ตามประเภทช่องทาง (Channel Type KPI)</h3>
        <canvas id="channelTypeChart" height="160"></canvas>
      </div>
    </div>

    <!-- Channel breakdown -->
    <div class="card p-5">
      <h3 class="text-lg font-semibold mb-3">Achievement แยกตามช่องทาง (Channel Breakdown)</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b border-white/10">
              <th class="py-2 pr-4">Channel</th>
              <th class="py-2 pr-4">Target</th>
              <th class="py-2 pr-4">Actual</th>
              <th class="py-2 pr-4">Achievement %</th>
              <th class="py-2">Records</th>
            </tr>
          </thead>
          <tbody id="channelBody"></tbody>
        </table>
      </div>
    </div>

    <div class="small mt-6 opacity-70">
      แหล่งข้อมูล: Google Sheets – 
      <a target="_blank" rel="noopener" href="https://docs.google.com/spreadsheets/d/11wQBNB5fuIE-ySyYtjjrc5-YDpyWq82zCCVRe_2PB_M/edit?gid=0#gid=0">เปิดดูชีต</a>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const SHEET_ID = "11wQBNB5fuIE-ySyYtjjrc5-YDpyWq82zCCVRe_2PB_M";
    const SHEET_NAME = "dailysale"; // sheet tab
    // จับคู่ชื่อคอลัมน์ที่เป็นไปได้ (เพิ่ม/แก้ได้)
    const POSSIBLE_COL_NAMES = {
      date: ["date","วันที่","docdate","transdate"],
      branch: ["branch","สาขา"],
      channel: ["channel type","channel","ประเภทช่องทาง"],
      target: ["target","ยอดเป้า","plan","goal"],
      actual: ["actual","ยอดจริง","sale","sales","revenue"]
    };

    // ========= UTIL =========
    const fmt = new Intl.NumberFormat("en-US",{maximumFractionDigits:2});
    const pct = (n)=> (isFinite(n)? (n*100).toFixed(1)+"%":"-");
    const keyOf = (obj)=> Object.keys(obj);

    function parseGViz(text){
      // gviz returns: google.visualization.Query.setResponse({...});
      const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
      return json.table;
    }

    function guessColumns(cols){
      const idx = {};
      const find = (wantList)=>{
        wantList = wantList.map(s=>s.toLowerCase());
        let hit = -1;
        cols.forEach((c,i)=>{
          const name = (c.label||c.id||"").toLowerCase().trim();
          if (wantList.some(w => name.includes(w)) && hit === -1) hit = i;
        });
        return hit;
      };
      idx.date   = find(POSSIBLE_COL_NAMES.date);
      idx.branch = find(POSSIBLE_COL_NAMES.branch);
      idx.channel= find(POSSIBLE_COL_NAMES.channel);
      idx.target = find(POSSIBLE_COL_NAMES.target);
      idx.actual = find(POSSIBLE_COL_NAMES.actual);
      return idx;
    }

    function parseDateCell(v){
      if (!v) return null;
      if (v instanceof Date) return v;
      if (typeof v === "string" && /^Date\(\d+,\d+,\d+/.test(v)){
        const m = v.match(/Date\((\d+),(\d+),(\d+)/);
        if (m) return new Date(+m[1], +m[2], +m[3]);
      }
      const d = new Date(v);
      return isNaN(+d)? null : d;
    }

    function groupBy(arr, keyFn){
      const m = new Map();
      arr.forEach(o=>{
        const k = keyFn(o);
        if(!m.has(k)) m.set(k, []);
        m.get(k).push(o);
      });
      return m;
    }

    function sum(arr, fn){ return arr.reduce((a,b)=>a+(+fn(b)||0),0); }

    // ========= LOAD =========
    async function loadSheet(){
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;
      const res = await fetch(url);
      const text = await res.text();
      const table = parseGViz(text);

      const colIdx = guessColumns(table.cols);
      const rows = table.rows.map(r=>{
        const c = r.c;
        return {
          date  : parseDateCell(c[colIdx.date]?.v),
          branch: (c[colIdx.branch]?.v ?? "").toString().trim(),
          channel: (c[colIdx.channel]?.v ?? "").toString().trim(),
          target: +((c[colIdx.target]?.v ?? 0) || 0),
          actual: +((c[colIdx.actual]?.v ?? 0) || 0),
          _raw: r
        };
      }).filter(x => x.date); // keep only valid dates

      return rows;
    }

    // ========= STATE =========
    let RAW = [];
    let overallChart, channelTypeChart;

    function applyFilters(){
      const f = document.getElementById("fromDate").value;
      const t = document.getElementById("toDate").value;
      const b = document.getElementById("branchSelect").value;

      let data = RAW.slice();

      if (f){
        const fd = new Date(f+"T00:00:00");
        data = data.filter(x=> x.date >= fd);
      }
      if (t){
        const td = new Date(t+"T23:59:59");
        data = data.filter(x=> x.date <= td);
      }
      if (b && b !== "__all__"){
        data = data.filter(x=> x.branch === b);
      }

      renderAll(data);
    }

    function resetFilters(){
      document.getElementById("fromDate").value = "";
      document.getElementById("toDate").value = "";
      document.getElementById("branchSelect").value = "__all__";
      renderAll(RAW);
    }

    // ========= RENDER =========
    function renderKPIs(data){
      const tgt = sum(data, d=>d.target);
      const act = sum(data, d=>d.actual);
      const ach = tgt ? (act/tgt) : 0;
      document.getElementById("kpiTarget").textContent = fmt.format(tgt);
      document.getElementById("kpiActual").textContent = fmt.format(act);
      document.getElementById("kpiAch").textContent    = pct(ach);
      document.getElementById("kpiRecords").textContent= fmt.format(data.length);
    }

    function renderBranchBars(data){
      const wrap = document.getElementById("branchBars");
      wrap.innerHTML = "";
      const byB = groupBy(data, d=>d.branch);
      [...byB.entries()].sort((a,b)=> a[0].localeCompare(b[0])).forEach(([branch, arr])=>{
        const tgt = sum(arr, d=>d.target);
        const act = sum(arr, d=>d.actual);
        const ratio = tgt ? Math.min(act/tgt, 1) : 0;
        const row = document.createElement("div");
        row.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <div class="font-medium">${branch || "-"}</div>
            <div class="small">${fmt.format(act)} / ${fmt.format(tgt)} • ${pct(tgt?act/tgt:0)}</div>
          </div>
          <div class="progress-outer"><div class="progress-inner" style="width:${ratio*100}%"></div></div>
        `;
        wrap.appendChild(row);
      });
    }

    function upsertChart(canvasId, cfg, currentRef){
      const ctx = document.getElementById(canvasId);
      if (currentRef) currentRef.destroy();
      return new Chart(ctx, cfg);
    }

    function renderOverallChart(data){
      const tgt = sum(data, d=>d.target);
      const act = sum(data, d=>d.actual);
      const ach = tgt? (act/tgt*100) : 0;

      const cfg = {
        type: "bar",
        data: {
          labels: ["Target","Actual","Achievement %"],
          datasets: [{
            label: "Overall",
            data: [tgt, act, ach],
          }]
        },
        options:{
          responsive:true,
          plugins:{ legend:{display:false}},
          scales:{
            y:{ beginAtZero:true }
          }
        }
      };
      overallChart = upsertChart("overallChart", cfg, overallChart);
    }

    function renderChannelTypeChart(data){
      const byC = groupBy(data, d=> d.channel || "-");
      const labels = [];
      const achs = [];
      [...byC.entries()].forEach(([ch, arr])=>{
        const tgt = sum(arr,d=>d.target);
        const act = sum(arr,d=>d.actual);
        labels.push(ch);
        achs.push( tgt ? act/tgt*100 : 0 );
      });

      const cfg = {
        type:"bar",
        data:{ labels, datasets:[{ label:"Achievement %", data:achs }]},
        options:{
          responsive:true,
          plugins:{ legend:{display:false}},
          scales:{
            y:{ beginAtZero:true, ticks:{ callback:(v)=> v+"%"}}
          }
        }
      };
      channelTypeChart = upsertChart("channelTypeChart", cfg, channelTypeChart);
    }

    function renderChannelBreakdown(data){
      const body = document.getElementById("channelBody");
      body.innerHTML = "";
      const byC = groupBy(data, d=> d.channel || "-");
      const rows = [...byC.entries()].map(([ch, arr])=>{
        const tgt = sum(arr,d=>d.target);
        const act = sum(arr,d=>d.actual);
        const ach = tgt ? (act/tgt) : 0;
        return { ch, tgt, act, ach, n: arr.length };
      }).sort((a,b)=> a.ch.localeCompare(b.ch));

      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.className = "border-b border-white/5";
        tr.innerHTML = `
          <td class="py-2 pr-4">${r.ch}</td>
          <td class="py-2 pr-4">${fmt.format(r.tgt)}</td>
          <td class="py-2 pr-4">${fmt.format(r.act)}</td>
          <td class="py-2 pr-4">${pct(r.ach)}</td>
          <td class="py-2">${r.n}</td>
        `;
        body.appendChild(tr);
      });
    }

    function renderBranchOptions(){
      const sel = document.getElementById("branchSelect");
      const branches = [...new Set(RAW.map(x=>x.branch))].filter(Boolean).sort();
      sel.innerHTML = `<option value="__all__">All</option>` + 
        branches.map(b=> `<option value="${b}">${b}</option>`).join("");
    }

    function renderAll(data){
      renderKPIs(data);
      renderBranchBars(data);
      renderOverallChart(data);
      renderChannelTypeChart(data);
      renderChannelBreakdown(data);
    }

    // ========= INIT =========
    (async function init(){
      RAW = await loadSheet();
      renderBranchOptions();
      renderAll(RAW);

      document.getElementById("applyBtn").addEventListener("click", applyFilters);
      document.getElementById("resetBtn").addEventListener("click", resetFilters);
    })();
  </script>
</body>
</html>
